<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>GPX Point Entry Tool</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; margin-top: 60px; background: #f4f4f4; }
        h2 { text-align: center; font-size: 20px; }
        #controls {
            display: flex;
            flex-direction: column;
            max-width: 450px;
            margin: 0 auto 20px auto;
            gap: 6px;
        }
        input, select, button { padding: 6px; font-size: 14px; border-radius: 4px; border: 1px solid #ccc; }
        button {
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: 0.2s;
            color: white;
        }
        #addBtn { background-color: #10b981; }
        #searchBtn { background-color: #3b82f6; }
        #exportBtn { background-color: #6366f1; }
        #clearAllBtn { background-color: #ef4444; }
        #addSelectedBtn { background-color: #f97316; }
        button:hover { filter: brightness(1.1); transform: translateY(-1px); }

        .table-container {
            overflow-x: auto;
            width: 100%;
            margin-top: 10px;
        }

        table {
            border-collapse: collapse;
            width: auto;
            min-width: 100%;
            background: white;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 4px;
            text-align: left;
            white-space: nowrap;
            font-size: 12px;
        }

        th {
            background: #007acc;
            color: white;
        }

        th:last-child, td:last-child {
            min-width: 55px;
            width: auto;
        }

        #fileInfo { font-size: 13px; color: #444; text-align: center; }
        #matchSelect { margin-top: 4px; display: none; width: 100%; font-size: 13px; }
    </style>
</head>
<body>

<h2>GPX Point Entry Tool</h2>

<div id="controls">
    <input type="file" id="fileInput" accept=".txt,.csv">
    <div id="fileInfo"></div>

    <input type="text" id="searchBox" placeholder="Search Name or Postcode">
    <button id="searchBtn">Search</button>

    <select id="matchSelect" size="4"></select>
    <button id="addSelectedBtn" style="display:none; margin-top:4px;">Add Selected</button>

    <input type="text" id="nameBox" placeholder="Enter Name (optional)">
    <input type="text" id="latBox" placeholder="Enter Latitude">
    <input type="text" id="lonBox" placeholder="Enter Longitude">
    <button id="addBtn">Add Point</button>
    <button id="exportBtn">Export GPX</button>
    <button id="clearSearchBtn" style="background-color:#6b7280;">Clear Search</button>
    <button id="clearAllBtn">Clear All</button>

    <div id="currentPos" style="font-size:14px; text-align:center; margin-top:6px; color:#333;">
        Current Position: Getting GPS...
    </div>
</div>

<div class="table-container">
    <table id="pointsTable">
        <thead>
        <tr>
            <th>Name</th>
            <th>Latitude</th>
            <th>Longitude</th>
            <th>Action</th>
        </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<script>
    let customerData = [];

    // DATE + TIME FOR GPX FILENAME (ADDED)
    function getTodayDMY_Time() {
        const d = new Date();
        const day = String(d.getDate()).padStart(2, '0');
        const month = String(d.getMonth() + 1).padStart(2, '0');
        const year = d.getFullYear();
        const hours = String(d.getHours()).padStart(2, '0');
        const minutes = String(d.getMinutes()).padStart(2, '0');
        return `${day}-${month}-${year}_${hours}-${minutes}`;
    }

    // GPS updater
    if (navigator.geolocation) {
        navigator.geolocation.watchPosition(
            pos => {
                const lat = pos.coords.latitude.toFixed(6);
                const lon = pos.coords.longitude.toFixed(6);
                document.getElementById('currentPos').innerText =
                    `Current Position: ${lat}, ${lon}`;
                document.getElementById('currentPos').style.color = '#10b981';
            },
            err => {
                let errorMsg;
                switch (err.code) {
                    case err.PERMISSION_DENIED:
                        errorMsg = "Access Denied. Ensure Android permission is granted.";
                        break;
                    case err.POSITION_UNAVAILABLE:
                        errorMsg = "Location information is unavailable.";
                        break;
                    case err.TIMEOUT:
                        errorMsg = "Timeout. Check GPS signal or try again.";
                        break;
                    default:
                        errorMsg = "An unknown GPS error occurred.";
                }
                document.getElementById('currentPos').innerText = `GPS Error: ${errorMsg}`;
                document.getElementById('currentPos').style.color = '#ef4444';
            },
            {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            }
        );
    } else {
        document.getElementById('currentPos').innerText = "GPS not supported.";
    }

    // Autoload file
    document.getElementById('fileInput').addEventListener('change', () => {
        const file = document.getElementById('fileInput').files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = e => {
            customerData = e.target.result.split(/\r?\n/).filter(Boolean);
            document.getElementById('fileInfo').innerText =
                `Loaded: ${file.name} (${customerData.length} entries)`;
        };
        reader.readAsText(file);
    });

    // Search
    document.getElementById('searchBtn').addEventListener('click', () => {
        const search = document.getElementById('searchBox').value.trim().toLowerCase();
        matchSelect.innerHTML = '';
        matchSelect.style.display = 'none';
        addSelectedBtn.style.display = 'none';
        if (!search) return;

        const matches = customerData.filter(line => line.toLowerCase().includes(search));
        if (matches.length === 0) alert("No matches found.");
        else if (matches.length === 1) insertLine(matches[0]);
        else {
            matches.forEach(m => {
                const opt = document.createElement('option');
                opt.textContent = m;
                matchSelect.appendChild(opt);
            });
            matchSelect.style.display = 'block';
        }
        document.getElementById('searchBox').value = '';
    });

    const matchSelect = document.getElementById('matchSelect');
    const addSelectedBtn = document.getElementById('addSelectedBtn');

    matchSelect.addEventListener('change', () => {
        addSelectedBtn.style.display = 'inline-block';
    });

    addSelectedBtn.addEventListener('click', () => {
        if (matchSelect.value) {
            insertLine(matchSelect.value);
            matchSelect.style.display = 'none';
            addSelectedBtn.style.display = 'none';
        }
    });

    // Manual add
    document.getElementById('addBtn').addEventListener('click', () => {
        const name = document.getElementById('nameBox').value.trim() || "Unnamed";
        const lat = document.getElementById('latBox').value.trim();
        const lon = document.getElementById('lonBox').value.trim();
        if (!lat || !lon) return alert("Please enter both latitude and longitude.");
        insertLine(`${name},${lat},${lon}`);
        document.getElementById('nameBox').value = '';
        document.getElementById('latBox').value = '';
        document.getElementById('lonBox').value = '';
    });

    // Export GPX (UPDATED FILENAME)
    document.getElementById('exportBtn').addEventListener('click', () => {
        const tbody = document.querySelector('#pointsTable tbody');
        if (tbody.rows.length === 0) return alert("No points to export.");

        let gpx = `<?xml version="1.0" encoding="UTF-8"?>\n` +
                  `<gpx version="1.1" creator="GPX Tool" xmlns="http://www.topografix.com/GPX/1/1">\n`;

        for (let row of tbody.rows) {
            gpx +=
`  <wpt lat="${row.cells[1].textContent}" lon="${row.cells[2].textContent}">
    <name>${row.cells[0].textContent}</name>
    <sym>Dot</sym>
    <type>Marks</type>
    <extensions>
      <color>0000ff</color>
    </extensions>
  </wpt>\n`;
        }

        gpx += `</gpx>`;

        const fileName = `Points-${getTodayDMY_Time()}.gpx`;

        if (window.Android && window.Android.saveGPX) {
            window.Android.saveGPX(gpx, fileName);
        } else {
            const blob = new Blob([gpx], { type: "application/gpx+xml" });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = fileName;
            a.click();
            URL.revokeObjectURL(a.href);
        }
    });

    // Clear Search
    document.getElementById('clearSearchBtn').addEventListener('click', () => {
        matchSelect.innerHTML = '';
        matchSelect.style.display = 'none';
        addSelectedBtn.style.display = 'none';
    });

    // Clear All
    document.getElementById('clearAllBtn').addEventListener('click', () => {
        document.querySelector('#pointsTable tbody').innerHTML = '';
        matchSelect.innerHTML = '';
        matchSelect.style.display = 'none';
        addSelectedBtn.style.display = 'none';
    });

    function parseLine(line) {
        line = line.replace(/"/g,'').trim();
        let parts = line.split(/[\t,]+|\s{2,}/).filter(Boolean);
        if (parts.length < 3) return { name: line, lat: null, lon: null };
        let lat = parts[parts.length - 2];
        let lon = parts[parts.length - 1];
        let name = parts.slice(0, -2).join(' ');
        return { name: name || "Unknown", lat, lon };
    }

    function insertLine(line) {
        const { name, lat, lon } = parseLine(line);
        if (!lat || !lon || isNaN(lat) || isNaN(lon)) {
            alert("Invalid coordinates:\n" + line);
            return;
        }
        const row = document.querySelector('#pointsTable tbody').insertRow();
        row.insertCell(0).textContent = name;
        row.insertCell(1).textContent = lat;
        row.insertCell(2).textContent = lon;
        const del = document.createElement('button');
        del.textContent = 'ðŸ—‘ï¸';
        del.onclick = () => row.remove();
        row.insertCell(3).appendChild(del);
    }
</script>

</body>
</html>
