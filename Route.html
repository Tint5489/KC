<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GPX Route Viewer</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
html, body { height: 100%; margin: 0; }
body {
  display: flex;
  flex-direction: row;
  height: 100vh;
  font-family: Arial, Helvetica, sans-serif;
  overflow: hidden;
  position: relative;
}

#map { flex: 3; min-width: 0; }

#sidebar {
  flex: 1;
  border-left: 1px solid #ccc;
  padding: 10px;
  background: #f9f9f9;
  display: flex;
  flex-direction: column;
  min-width: 240px;
  position: relative;
  transition: transform 0.3s ease;
  z-index: 10;
}

/* Table styles */
.table-container {
  width: 100%;
  overflow-x: auto;
  overflow-y: scroll;
  -webkit-overflow-scrolling: touch;
  height: 300px;
  max-height: 400px;
  min-height: 120px;
  background: white;
  margin-bottom: 14px;
  border-radius: 4px;
  border: 2px solid #dadada;
  box-shadow: 0 2px 8px -2px #bbb;
  padding-bottom: 10px;
  transition: height 0.2s ease;
}
.table-container::-webkit-scrollbar { width: 16px; background: #e3e3e3; border-radius: 8px; }
.table-container::-webkit-scrollbar-thumb { background: #007bff; border-radius: 8px; border: 4px solid #e3e3e3; }

table {
  width: 100%;
  border-collapse: collapse;
  font-size: 16px;
  min-width: 260px;
  background: white;
}
th, td {
  padding: 10px 8px;
  border: 1px solid #ddd;
  text-align: left;
  font-size: 15px;
  background: white;
}
th:first-child, td:first-child { width: 1%; white-space: nowrap; text-align: center; }
tr { cursor: grab; }

/* Numbered markers */
.numbered-marker div {
  background: #007bff;
  color: white;
  border-radius: 50%;
  width: 26px;
  height: 26px;
  text-align: center;
  line-height: 26px;
  font-weight: bold;
  border: 2px solid white;
}

/* Collapsed sidebar (desktop) */
body.collapsed #sidebar {
  width: auto;
  padding: 0;
}
body.collapsed table { width: auto !important; table-layout: auto !important; }
body.collapsed th:nth-child(2), body.collapsed td:nth-child(2) { display: none; }

/* Resize handle */
#resizeHandle {
  height: 40px;
  background: #eee;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: row-resize;
  user-select: none;
  touch-action: none;
  margin: 8px 0;
  border-radius: 6px;
}
#resizeHandle .hamb span {
  display: block;
  height: 4px;
  width: 30px;
  background: #666;
  margin: 5px 0;
  border-radius: 2px;
}

/* Mobile floating drawer fully off-screen */
@media (max-width: 820px){
  #sidebar {
    position: absolute;
    top: 0;
    right: 0;
    width: 240px;
    height: 100%;
    transform: translateX(0);
    box-shadow: -4px 0 12px rgba(0,0,0,0.4);
    background: #f9f9f9;
    padding: 10px;
    z-index: 9999;  
    transition: transform 0.2s ease;
  }
  #sidebar.collapsed { 
    transform: translateX(100%); /* fully off-screen */
  }
  #sidebar.dragging { transition: none; }

  /* Arrow toggle button */
  #sidebarToggle {
    position: fixed; /* fixed so it stays visible */
    right: 0;        
    top: 50%;
    transform: translateY(-50%);
    width: 30px;
    height: 50px;
    background: #007bff;
    color: white;
    font-size: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 4px 0 0 4px;
    cursor: pointer;
    z-index: 10000;
  }
}
</style>
</head>
<body>
<div id="map"></div>

<!-- Toggle button outside sidebar -->
<div id="sidebarToggle">&#x25C0;</div>

<div id="sidebar">
  <div id="dragHandle"></div>
  <h2>Stops</h2>
  <input type="file" id="gpxFile" accept=".gpx"><br><br>
  <div id="resizeHandle"><div class="hamb"><span></span><span></span><span></span></div></div>
  <div class="table-container" id="tableContainer">
    <table id="stopsTable"><thead><tr><th>#</th><th>Name</th></tr></thead><tbody></tbody></table>
  </div>
  <button id="downloadGpxBtn">Download Reordered GPX</button>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/togeojson"></script>
<script src="https://unpkg.com/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
// Map setup
const map=L.map('map').setView([51.505,-0.09],13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);

// Variables
let stops=[],markers=[],sortable=null, routeLine=null;
const tbody=document.querySelector("#stopsTable tbody");
const tableContainer=document.getElementById("tableContainer");
const resizeHandle=document.getElementById("resizeHandle");
const dragHandle=document.getElementById("dragHandle");
const sidebar=document.getElementById("sidebar");
const downloadBtn=document.getElementById("downloadGpxBtn");
const toggleBtn=document.getElementById("sidebarToggle");

// Initially collapsed on mobile
if(window.innerWidth < 820) sidebar.classList.add("collapsed");

// Arrow toggle (always visible)
toggleBtn.addEventListener("click", () => {
  sidebar.classList.toggle("collapsed");
  toggleBtn.innerHTML = sidebar.classList.contains("collapsed") ? "&#x25B6;" : "&#x25C0;";
  setTimeout(()=>map.invalidateSize(),200);
});

// Handle GPX file
document.getElementById("gpxFile").addEventListener("change", e=>{
  const file=e.target.files[0]; if(!file) return;
  const reader=new FileReader();
  reader.onload=function(evt){
    const xmlDoc=new DOMParser().parseFromString(evt.target.result,"text/xml");
    const geojson=toGeoJSON.gpx(xmlDoc);
    stops=geojson.features.filter(f=>f.geometry.type==="Point").map((f,i)=>({
      name:f.properties.name||`Stop ${i+1}`,
      lat:f.geometry.coordinates[1],
      lon:f.geometry.coordinates[0]
    }));
    updateTable(); initSortable(); updateMarkers();
  }
  reader.readAsText(file);
});

// Table update
function updateTable(){tbody.innerHTML=""; stops.forEach((stop,i)=>{const row=document.createElement("tr"); row.dataset.index=i; row.innerHTML=`<td>${i+1}</td><td>${stop.name}</td>`; tbody.appendChild(row);});}

// Map markers
function updateMarkers(){
  markers.forEach(m=>map.removeLayer(m)); markers=[];
  stops.forEach((stop,i)=>{
    const icon=L.divIcon({className:"numbered-marker", html:`<div>${i+1}</div>`, iconSize:[30,30], iconAnchor:[15,30]});
    const marker=L.marker([stop.lat,stop.lon],{icon}).addTo(map).bindTooltip(`${i+1}. ${stop.name}`,{permanent:true,direction:"top",offset:[0,-35]});
    markers.push(marker);
  });
  updateRoute();
}

// Draw polyline route
function updateRoute() {
  if(routeLine) map.removeLayer(routeLine);
  if(stops.length<2) return;
  const latlngs=stops.map(s=>[s.lat,s.lon]);
  routeLine=L.polyline(latlngs,{color:'blue',weight:4,opacity:0.7}).addTo(map);
  const group=L.featureGroup([...markers,routeLine]);
  map.fitBounds(group.getBounds(),{padding:[40,40]});
}

// Sortable
function initSortable(){if(sortable)sortable.destroy(); sortable=Sortable.create(tbody,{animation:150, handle:"td:first-child", onEnd:()=>{const newStops=[]; tbody.querySelectorAll("tr").forEach(row=>{const oldIndex=parseInt(row.dataset.index,10); newStops.push(stops[oldIndex]);}); stops=newStops; updateTable(); updateMarkers(); initSortable();}});}

// Download GPX
downloadBtn.addEventListener("click",()=>{
  const now=new Date(); const filename=`Stops-${now.getFullYear()}-${(now.getMonth()+1).toString().padStart(2,'0')}-${now.getDate().toString().padStart(2,'0')}-${now.getHours().toString().padStart(2,'0')}-${now.getMinutes().toString().padStart(2,'0')}.gpx`;
  let gpx=`<?xml version="1.0" encoding="UTF-8"?><gpx version="1.1" creator="GPXRouteViewer" xmlns="http://www.topografix.com/GPX/1/1">`;
  stops.forEach((s,i)=>{gpx+=`<wpt lat="${s.lat}" lon="${s.lon}"><name>${i+1}. ${s.name}</name></wpt>`;});
  gpx+=`</gpx>`;
  const blob=new Blob([gpx],{type:"application/gpx+xml"}); const url=URL.createObjectURL(blob); const a=document.createElement("a"); a.href=url; a.download=filename; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
});

// Resize table
let startY=0,startHeight=0,resizing=false;
function initResize(e){resizing=true; startY=e.clientY; startHeight=parseInt(window.getComputedStyle(tableContainer).height,10); document.addEventListener("pointermove",doResize); document.addEventListener("pointerup",stopResize); e.preventDefault();}
function doResize(e){if(!resizing) return; let dy=startY-e.clientY; let newH=startHeight+dy; newH=Math.max(120,Math.min(700,newH)); tableContainer.style.height=newH+"px"; tableContainer.style.maxHeight=newH+"px"; e.preventDefault();}
function stopResize(){if(!resizing) return; resizing=false; document.removeEventListener("pointermove",doResize); document.removeEventListener("pointerup",stopResize); setTimeout(()=>map.invalidateSize(),150);}
resizeHandle.addEventListener("pointerdown",initResize);

// Mobile drawer drag
let dragging=false,startX=0,startTransform=0;
dragHandle.addEventListener("pointerdown", e=>{
  dragging=true; startX=e.clientX;
  const style=getComputedStyle(sidebar); startTransform=parseFloat(style.transform.split(",")[4]||style.transform.split("(")[1]);
  sidebar.classList.add("dragging");
  e.preventDefault();
});
document.addEventListener("pointermove", e=>{
  if(!dragging) return;
  let dx=e.clientX-startX;
  let newX=Math.min(240, Math.max(0, startTransform+dx));
  sidebar.style.transform=`translateX(${newX}px)`;
});
document.addEventListener("pointerup", e=>{
  if(!dragging) return;
  dragging=false; sidebar.classList.remove("dragging");
  let style=getComputedStyle(sidebar); let tx=parseFloat(style.transform.split(",")[4]||style.transform.split("(")[1]);
  if(tx>120) sidebar.style.transform=`translateX(100%)`;
  else sidebar.style.transform=`translateX(0px)`;
  setTimeout(()=>map.invalidateSize(),200);
});
</script>
</body>
</html>
