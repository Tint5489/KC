<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Route Planner with Numbered Pins</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css"/>

<style>
  html, body { height:100%; margin:0; font-family:Arial,Helvetica,sans-serif; width:100vw; overflow:hidden; background:#fafbfc; }
  #map { position:absolute; top:0; left:0; right:0; bottom:0; width:100vw; height:100vh; z-index:1; }

  #sidebar {
    position: fixed; top:0; right:0; height:100vh; width:340px;
    background:#f9f9f9; border-left:1px solid #ccc; padding:14px; box-sizing:border-box;
    overflow:auto; z-index:1200; transition: transform .28s ease;
    transform: translateX(0); min-width:240px; max-width:420px;
  }
  #sidebar.collapsed { transform: translateX(100%); }

  #sidebarToggle {
    position: fixed; right:0; top:50%; transform:translateY(-50%);
    width:36px; height:54px; background:#007bff; color:#fff;
    display:flex; align-items:center; justify-content:center; font-size:22px;
    cursor:pointer; border-radius:6px 0 0 6px; z-index:20000;
  }

  .table-container { background:#fff; border:2px solid #dadada; border-radius:6px;
    box-shadow:0 2px 8px -2px #bbb; padding:6px; overflow:auto; margin-top:10px; }
  table { border-collapse:collapse; width:100%; font-size:15px; }
  th, td { padding:6px 8px; border:1px solid #ddd; text-align:left; }
  tr { cursor:grab; }
  tr.dragging { background:#ffeeba; }

  #routeInfo { font-weight:500; margin-top:10px; color:#333; }

  #resizeHandle {
    height:36px; background:#eee; border-radius:6px;
    display:flex; align-items:center; justify-content:center;
    margin-top:8px; user-select:none; touch-action:none;
  }
  #resizeHandle .hamb span { display:block; height:3px; width:28px; background:#666; margin:4px 0; border-radius:2px; }

  .leaflet-div-icon { background:none!important; border:none!important; box-shadow:none!important; }

  @media (max-width:820px){
    #sidebar { width:auto; min-width:200px; max-width:92vw; box-shadow:-6px 0 18px rgba(0,0,0,0.25); }
    .table-container{ max-height:60vh; }
  }
</style>
</head>
<body>

<div id="map"></div>
<div id="sidebarToggle">&#x25B6;</div>

<aside id="sidebar">
  <h2 style="margin:6px 0 8px 0">Route Planner</h2>

  <label for="fileInput">Import stops from GPX file:</label>
  <input type="file" id="fileInput" accept=".gpx"/>

  <div id="routeInfo">Total distance: 0 km, Estimated time: 0h 0m</div>

  <div id="resizeHandle" title="Drag to resize table height"><div class="hamb"><span></span><span></span><span></span></div></div>

  <div class="table-container" id="tableContainer" style="height:300px">
    <table id="stopsTable">
      <thead><tr><th>#</th><th>Stop</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</aside>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
<script src="https://unpkg.com/@mapbox/togeojson@0.16.0/togeojson.js"></script>

<script>
const WORK_START = { name:"Start", lat:54.971723, lon:-2.949500 };
const WORK_STOP  = { name:"End", lat:54.971730, lon:-2.949550 };
const DEFAULT_CENTER = [54.58303,-2.56954];
const DEFAULT_ZOOM = 6;

let stops = [WORK_START, WORK_STOP];
let markers = [];
let routingControl = null;
let sortable = null;

const sidebar = document.getElementById('sidebar');
const toggleBtn = document.getElementById('sidebarToggle');
const tbody = document.querySelector("#stopsTable tbody");
const routeInfoEl = document.getElementById("routeInfo");
const tableContainer = document.getElementById("tableContainer");
const resizeHandle = document.getElementById("resizeHandle");

const map = L.map('map').setView(DEFAULT_CENTER, DEFAULT_ZOOM);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ attribution:'&copy; OpenStreetMap contributors' }).addTo(map);

function pinIconHtml(num) {
  return `
    <svg width="34" height="46" viewBox="0 0 34 46" xmlns="http://www.w3.org/2000/svg">
      <path d="M17 0C7.6 0 0 7.6 0 17c0 12 13.4 28.2 14.1 29 .5.7 1.3 1.1 2 .9.7.2 1.5-.2 2-.9C20.6 45.2 34 29 34 17 34 7.6 26.4 0 17 0z" fill="#007bff" stroke="#fff" stroke-width="2"/>
      <circle cx="17" cy="17" r="8.5" fill="#fff"/>
      <text x="17" y="22" text-anchor="middle" fill="#007bff" font-size="14" font-family="Arial" font-weight="bold">${num}</text>
    </svg>`;
}

function updateTable(){
  tbody.innerHTML = "";
  stops.forEach((stop,i)=>{
    const row = document.createElement("tr");
    row.dataset.index = i;
    row.innerHTML = `<td>${i+1}</td><td>${stop.name}</td>`;
    tbody.appendChild(row);
  });
}

function updateMarkers(){
  // Remove existing markers
  markers.forEach(m => map.removeLayer(m));
  markers = [];

  // Add one marker per stop with number
  stops.forEach((s,i)=>{
    const icon = L.divIcon({
      className:'leaflet-div-icon',
      html: pinIconHtml(i+1),
      iconSize:[34,46],
      iconAnchor:[17,46]
    });
    markers.push(L.marker([s.lat,s.lon],{icon}).addTo(map));
  });

  updateRoute();
}

function updateRoute(){
  if(routingControl){ map.removeControl(routingControl); routingControl=null; }
  if(stops.length<2){ routeInfoEl.textContent="Total distance: 0 km, Estimated time: 0h 0m"; return; }

  const waypoints=stops.map(s=>L.latLng(s.lat,s.lon));
  routingControl=L.Routing.control({
    waypoints,
    lineOptions:{ styles:[{ color:'#007bff', weight:4, opacity:0.8 }] },
    addWaypoints:false, draggableWaypoints:false, show:false, fitSelectedRoutes:true
  }).addTo(map);

  routingControl.on('routesfound', e=>{
    const route = e.routes[0];
    if(route && route.summary){
      const distKm=(route.summary.totalDistance/1000).toFixed(1);
      const totalSec=route.summary.totalTime;
      const hours=Math.floor(totalSec/3600);
      const mins=Math.round((totalSec%3600)/60);
      routeInfoEl.textContent=`Total distance: ${distKm} km, Estimated time: ${hours}h ${mins}m`;
    }
  });
}

function initSortable(){
  if(sortable) sortable.destroy();
  sortable=Sortable.create(tbody,{
    handle:'td', animation:160,
    onEnd:function(){
      const newStops=[];
      tbody.querySelectorAll('tr').forEach(row=>{
        const oldIndex=parseInt(row.dataset.index,10);
        newStops.push(stops[oldIndex]);
      });
      stops=[WORK_START,...newStops.slice(1,-1),WORK_STOP];
      updateTable(); updateMarkers(); initSortable();
    }
  });
}

document.getElementById("fileInput").addEventListener("change", async ev=>{
  const f = ev.target.files && ev.target.files[0]; if(!f) return;
  try{
    const text = await f.text();
    const xml = new DOMParser().parseFromString(text,"text/xml");
    const geojson = toGeoJSON.gpx(xml);
    const pts = geojson.features.filter(ft=>ft.geometry && ft.geometry.type==="Point");
    const userStops = pts.map(ft=>({ name: ft.properties.name||ft.properties.desc||"Stop", lat: ft.geometry.coordinates[1], lon: ft.geometry.coordinates[0] }));
    stops=[WORK_START,...userStops,WORK_STOP];
    updateTable(); initSortable(); updateMarkers();
  }catch(err){ alert("Failed to import GPX: "+err.message); }
});

toggleBtn.addEventListener('click',()=>{
  sidebar.classList.toggle('collapsed');
  sidebar.style.transform='';
  toggleBtn.innerHTML = sidebar.classList.contains('collapsed')?'&#x25C0;':'&#x25B6;';
  setTimeout(()=>map.invalidateSize(),200);
});

window.addEventListener('load',()=>{ sidebar.classList.remove('collapsed'); toggleBtn.innerHTML='&#x25B6;'; });

let resizing=false, startY=0, startH=0;
function startResize(e){ resizing=true; startY=e.clientY; startH=tableContainer.offsetHeight; document.addEventListener('pointermove',onResize); document.addEventListener('pointerup',stopResize); e.preventDefault();}
function onResize(e){ if(!resizing) return; let newH=startH+startY-e.clientY; newH=Math.max(120,Math.min(800,newH)); tableContainer.style.height=newH+'px'; setTimeout(()=>map.invalidateSize(),50);}
function stopResize(){ resizing=false; document.removeEventListener('pointermove',onResize); document.removeEventListener('pointerup',stopResize); setTimeout(()=>map.invalidateSize(),100);}
resizeHandle.addEventListener('pointerdown',startResize);

updateTable(); initSortable(); updateMarkers();
</script>
</body>
</html>
