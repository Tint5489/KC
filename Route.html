<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Route Planner with Sidebar Drawer</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css"/>

<style>
  :root { --accent:#007bff; }
  html, body { height:100%; margin:0; font-family:Arial,Helvetica,sans-serif; }
  body { display:flex; height:100vh; flex-direction:row; overflow:hidden; background:#fafbfc; }

  /* Map */
  #map { flex:3; min-width:0; }

  /* Sidebar */
  #sidebar {
    flex:0 0 auto;
    background:#f9f9f9;
    border-left:1px solid #ccc;
    padding:14px;
    box-sizing:border-box;
    min-width:240px;
    max-width:420px;
    transition: transform .28s ease;
    z-index:1200;
    overflow:auto;
  }
  #sidebar.collapsed { transform:translateX(100%); }

  /* Persistent toggle arrow */
  #sidebarToggle {
    position:fixed;
    right:0;
    top:50%;
    transform:translateY(-50%);
    width:36px; height:54px;
    background:var(--accent); color:#fff;
    display:flex; align-items:center; justify-content:center;
    font-size:22px; cursor:pointer;
    border-radius:6px 0 0 6px;
    z-index:20000;
  }

  /* Table */
  .table-container { background:#fff; border:2px solid #dadada; border-radius:6px; box-shadow:0 2px 8px -2px #bbb; padding:6px; overflow:auto; margin-top:10px; }
  table { border-collapse:collapse; width:100%; font-size:15px; }
  th, td { padding:6px 8px; border:1px solid #ddd; text-align:left; }
  tr { cursor:grab; }
  tr.dragging { background:#ffeeba; }

  /* Numbered marker style */
  .numbered-marker div {
    background:var(--accent); color:white; border-radius:50%;
    width:26px; height:26px; line-height:26px; text-align:center;
    font-weight:700; border:2px solid white;
  }

  #routeInfo { font-weight:500; margin-top:10px; color:#333; }

  /* Resize handle */
  #resizeHandle {
    height:36px; background:#eee; border-radius:6px;
    display:flex; align-items:center; justify-content:center;
    margin-top:8px; user-select:none; touch-action:none;
  }
  #resizeHandle .hamb span {
    display:block; height:3px; width:28px;
    background:#666; margin:4px 0; border-radius:2px;
  }

  /* Small screens */
  @media (max-width:820px){
    body { flex-direction:column; }
    #map { flex:1; height:100vh; }
    #sidebar {
      position:fixed; top:0; right:0; bottom:0;
      width:auto; min-width:200px; max-width:92%;
      transform:translateX(0);
      box-shadow:-6px 0 18px rgba(0,0,0,0.25);
    }
    #sidebar.collapsed{ transform:translateX(100%); }
    .table-container{ max-height:60vh; }
  }
</style>
</head>
<body>

<div id="map"></div>

<!-- Sidebar toggle button -->
<div id="sidebarToggle" aria-label="Toggle sidebar">&#x25B6;</div>

<aside id="sidebar" role="complementary" aria-label="Stops sidebar">
  <h2 style="margin:6px 0 8px 0">Route Planner</h2>

  <label for="fileInput">Import stops from GPX file:</label>
  <input type="file" id="fileInput" accept=".gpx" aria-label="Load GPX file"/>

  <div id="routeInfo">Total distance: 0 km, Estimated time: 0h 0m</div>

  <div id="resizeHandle" title="Drag to resize table height">
    <div class="hamb"><span></span><span></span><span></span></div>
  </div>

  <div class="table-container" id="tableContainer" style="height:300px">
    <table id="stopsTable" aria-label="Stops list">
      <thead>
        <tr><th>#</th><th>Stop</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</aside>

<!-- Libraries -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
<script src="https://unpkg.com/@mapbox/togeojson@0.16.0/togeojson.js"></script>

<script>
// === Constants ===
const WORK_STOP = { name:"BlendBetter", lat:54.971723, lon:-2.949500 };
const DEFAULT_CENTER = [54.58303,-2.56954];
const DEFAULT_ZOOM = 6;

// === State ===
let stops = [WORK_STOP, WORK_STOP];
let markers = [];
let routingControl = null;
let sortable = null;

// === DOM ===
const sidebar = document.getElementById('sidebar');
const toggleBtn = document.getElementById('sidebarToggle');
const tbody = document.querySelector("#stopsTable tbody");
const routeInfoEl = document.getElementById("routeInfo");
const tableContainer = document.getElementById("tableContainer");
const resizeHandle = document.getElementById("resizeHandle");

// === Map ===
const map = L.map('map').setView(DEFAULT_CENTER, DEFAULT_ZOOM);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  attribution:'&copy; OpenStreetMap contributors'
}).addTo(map);

// === Table update ===
function updateTable() {
  tbody.innerHTML="";
  stops.forEach((stop,i)=>{
    const row=document.createElement("tr");
    row.dataset.index=i;
    row.innerHTML=`<td>${i+1}</td><td>${stop.name}</td>`;
    tbody.appendChild(row);
  });
}

// === Markers ===
function updateMarkers() {
  markers.forEach(m=>map.removeLayer(m));
  markers = stops.map((s,i)=>{
    const icon=L.divIcon({ className:'numbered-marker', html:`<div>${i+1}</div>`, iconSize:[30,30], iconAnchor:[15,30] });
    return L.marker([s.lat,s.lon],{icon}).addTo(map)
      .bindTooltip(`${i+1}. ${s.name}`,{permanent:true,direction:'top',offset:[0,-36],className:'stop-label'});
  });
  updateRoute();
}

// === Route ===
function updateRoute() {
  if(routingControl){ map.removeControl(routingControl); routingControl=null; }
  if(stops.length<2){
    routeInfoEl.textContent="Total distance: 0 km, Estimated time: 0h 0m";
    return;
  }
  const waypoints=stops.map(s=>L.latLng(s.lat,s.lon));
  routingControl=L.Routing.control({
    waypoints,
    lineOptions:{ styles:[{ color:'#007bff', weight:4, opacity:0.8 }] },
    addWaypoints:false,
    draggableWaypoints:false,
    show:false,
    fitSelectedRoutes:false
  }).addTo(map);

  routingControl.on('routesfound', e=>{
    const route=e.routes[0];
    if(route && route.summary){
      const distKm=(route.summary.totalDistance/1000).toFixed(1);
      const totalSec=route.summary.totalTime;
      const hours=Math.floor(totalSec/3600);
      const mins=Math.round((totalSec%3600)/60);
      routeInfoEl.textContent=`Total distance: ${distKm} km, Estimated time: ${hours}h ${mins}m`;
    }
  });
}

// === Sortable ===
function initSortable(){
  if(sortable) sortable.destroy();
  sortable=Sortable.create(tbody,{
    handle:'td',
    animation:160,
    onEnd:function(){
      const newStops=[];
      tbody.querySelectorAll('tr').forEach(row=>{
        const oldIndex=parseInt(row.dataset.index,10);
        newStops.push(stops[oldIndex]);
      });
      stops=[WORK_STOP,...newStops.slice(1,-1),WORK_STOP];
      updateTable(); updateMarkers(); initSortable();
    }
  });
}

// === File Import ===
document.getElementById("fileInput").addEventListener("change", async ev=>{
  const f=ev.target.files && ev.target.files[0];
  if(!f) return;
  try{
    const text=await f.text();
    const xml=new DOMParser().parseFromString(text,"text/xml");
    const geojson=toGeoJSON.gpx(xml);
    const pts=geojson.features.filter(ft=>ft.geometry && ft.geometry.type==="Point");
    const userStops=pts.map(ft=>({
      name: ft.properties.name||ft.properties.desc||"Stop",
      lat: ft.geometry.coordinates[1],
      lon: ft.geometry.coordinates[0]
    }));
    stops=[WORK_STOP,...userStops,WORK_STOP];
    updateTable(); initSortable(); updateMarkers();
  }catch(err){ alert("Failed to import GPX: "+err.message); }
});

// === Sidebar toggle ===
toggleBtn.addEventListener('click',()=>{
  sidebar.classList.toggle('collapsed');
  sidebar.style.transform='';
  const collapsed=sidebar.classList.contains('collapsed');
  toggleBtn.innerHTML=collapsed?'&#x25C0;':'&#x25B6;';
  setTimeout(()=>map.invalidateSize(),200);
});
window.addEventListener('load',()=>{
  sidebar.classList.remove('collapsed');
  toggleBtn.innerHTML='&#x25B6;';
});

// === Resize table ===
let resizing=false,startY=0,startH=0;
function startResize(e){
  resizing=true;
  startY=e.clientY;
  startH=tableContainer.offsetHeight;
  document.addEventListener('pointermove',onResize);
  document.addEventListener('pointerup',stopResize);
  e.preventDefault();
}
function onResize(e){
  if(!resizing) return;
  const dy=startY-e.clientY;
  let newH=startH+dy;
  newH=Math.max(120,Math.min(800,newH));
  tableContainer.style.height=newH+'px';
  setTimeout(()=>map.invalidateSize(),50);
}
function stopResize(){
  resizing=false;
  document.removeEventListener('pointermove',onResize);
  document.removeEventListener('pointerup',stopResize);
  setTimeout(()=>map.invalidateSize(),100);
}
resizeHandle.addEventListener('pointerdown',startResize);

// === Init ===
updateTable(); initSortable(); updateMarkers();
</script>
</body>
</html>
