<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Route Planner with Numbered Stops</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css"/>

<style>
html, body {
  height:100%; margin:0; font-family:Arial,Helvetica,sans-serif;
  width:100vw; overflow:hidden; background:#fafbfc;
}
#map { position:absolute; top:0; left:0; right:0; bottom:0; }

#sidebar {
  position: fixed; top:0; right:0; height:100vh; width:340px;
  background:#f9f9f9; border-left:1px solid #ccc;
  padding:14px; box-sizing:border-box; overflow:auto;
  z-index:1200; transition: transform .28s ease;
  transform: translateX(0); min-width:240px; max-width:420px;
}
#sidebar.collapsed { transform: translateX(100%); }

#sidebarToggle {
  position: fixed; right:0; top:50%; transform:translateY(-50%);
  width:36px; height:54px; background:#007bff; color:#fff;
  display:flex; align-items:center; justify-content:center;
  font-size:22px; cursor:pointer;
  border-radius:6px 0 0 6px; z-index:20000;
}

.table-container { background:#fff; border:2px solid #dadada; border-radius:6px;
  box-shadow:0 2px 8px -2px #bbb; overflow:auto; margin-top:10px; }
table { border-collapse:collapse; width:100%; font-size:13px; }
th, td { padding:4px 6px; border:1px solid #ddd; text-align:left; }
tr { cursor:grab; }
tr.locked { cursor:default; background:#f1f1f1; }
tr.dragging { background:#ffeeba; }

#routeInfo { font-weight:500; margin-top:10px; color:#333; }
.number-icon div { line-height:20px; text-align:center; }

.leaflet-marker-icon, .leaflet-marker-shadow { background:none!important; border:none!important; }

@media (max-width:820px){
  #sidebar { width:auto; min-width:200px; max-width:92vw; box-shadow:-6px 0 18px rgba(0,0,0,0.25); }
}
</style>
</head>
<body>

<div id="map"></div>
<div id="sidebarToggle">&#x25B6;</div>

<aside id="sidebar">
  <h2 style="margin:6px 0 8px 0">Route Planner</h2>

  <label for="fileInput">Import stops from GPX file:</label>
  <input type="file" id="fileInput" accept=".gpx"/>

  <div style="margin-top:8px;">
    <button id="toggleLocation">Enable Current Location</button>
    <button id="exportBtn">Export GPX</button>
    <button id="deleteStop">Delete Selected Stop</button>
  </div>

  <div id="routeInfo">Total distance: 0 km (0 mi), Estimated time: 0h 0m</div>

  <div class="table-container" id="tableContainer">
    <table id="stopsTable">
      <thead><tr><th>#</th><th>Stop</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</aside>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
<script src="https://unpkg.com/@mapbox/togeojson@0.16.0/togeojson.js"></script>

<script>
const WORK_START = { name:"Start", lat:54.971723, lon:-2.949500 };
const WORK_STOP  = { name:"End", lat:54.971730, lon:-2.949550 };
const DEFAULT_CENTER = [54.58303,-2.56954];
const DEFAULT_ZOOM = 6;

let stops = [WORK_START, WORK_STOP];
let markers = [];
let routingControl = null;
let sortable = null;
let locationMarker = null;
let locationWatch = null;
let selectedRow = null;
let wakeLock = null;

const sidebar = document.getElementById('sidebar');
const toggleBtn = document.getElementById('sidebarToggle');
const tbody = document.querySelector("#stopsTable tbody");
const routeInfoEl = document.getElementById("routeInfo");
const exportBtn = document.getElementById("exportBtn");

const map = L.map('map').setView(DEFAULT_CENTER, DEFAULT_ZOOM);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  attribution:'&copy; OpenStreetMap contributors'
}).addTo(map);

/* --- Utils --- */
function escapeHtml(str){ return str.replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m])); }
function getColor(i){ return (i===0||i===stops.length-1) ? "red":"blue"; }

/* --- Table --- */
function updateTable(){
  tbody.innerHTML="";
  stops.forEach((s,i)=>{
    const tr=document.createElement("tr");
    tr.dataset.index=i;
    if(i===0 || i===stops.length-1) tr.classList.add("locked");
    tr.innerHTML=`<td>${i+1}</td><td>${escapeHtml(s.name||"Stop")}</td>`;
    tbody.appendChild(tr);
  });
  resizeTableToFitRows();
}

function resizeTableToFitRows(){
  const rows = tbody.querySelectorAll("tr").length;
  const height = Math.min(400, rows*28 + 60);
  document.getElementById("tableContainer").style.height = height+"px";
}

/* --- Markers --- */
function updateMarkers(){
  markers.forEach(m=>map.removeLayer(m));
  markers=[];
  stops.forEach((s,i)=>{
    const icon = L.divIcon({
      className:'number-icon',
      html:`<div style="font-size:22px; font-weight:bold; color:${getColor(i)};">${i+1}</div>`,
      iconSize:[20,20],
      iconAnchor:[10,10]
    });
    markers.push(L.marker([s.lat,s.lon],{icon}).addTo(map));
  });
  updateRoute(false);
}

/* --- Route --- */
function updateRoute(fitBounds=true){
  if(routingControl){ map.removeControl(routingControl); routingControl=null; }
  if(stops.length<2){ routeInfoEl.textContent="Total distance: 0 km (0 mi), Estimated time: 0h 0m"; return; }
  const waypoints=stops.map(s=>L.latLng(s.lat,s.lon));
  routingControl=L.Routing.control({
    waypoints,
    lineOptions:{ styles:[{ color:'#007bff', weight:4, opacity:0.8 }] },
    addWaypoints: false,
    draggableWaypoints: false,
    show: false,
    fitSelectedRoutes: fitBounds,
    createMarker: function() { return null; }
  }).addTo(map);

  routingControl.on('routesfound', e=>{
    const route=e.routes[0];
    if(route && route.summary){
      const distKm=(route.summary.totalDistance/1000).toFixed(1);
      const distMi=(route.summary.totalDistance/1609.34).toFixed(1);
      const totalSec=route.summary.totalTime;
      const hours=Math.floor(totalSec/3600);
      const mins=Math.round((totalSec%3600)/60);
      routeInfoEl.textContent=`Total distance: ${distKm} km (${distMi} mi), Estimated time: ${hours}h ${mins}m`;
    }
  });
}

/* --- Sortable --- */
function initSortable(){
  if(sortable){ try{sortable.destroy();}catch(e){} }
  sortable=Sortable.create(tbody,{
    handle:'td', animation:160,
    filter:'tr.locked',
    onEnd:function(){
      const newStops=[];
      tbody.querySelectorAll('tr').forEach(row=>{
        const oldIndex=parseInt(row.dataset.index,10);
        newStops.push(stops[oldIndex]);
      });
      stops=[WORK_START,...newStops.slice(1,-1),WORK_STOP];
      updateTable(); updateMarkers(); initSortable();
    }
  });
}

/* --- File Import --- */
document.getElementById("fileInput").addEventListener("change", async ev=>{
  const f=ev.target.files && ev.target.files[0]; if(!f) return;
  try{
    const text=await f.text();
    const xml=new DOMParser().parseFromString(text,"text/xml");
    const geojson=toGeoJSON.gpx(xml);
    const pts=geojson.features.filter(ft=>ft.geometry && ft.geometry.type==="Point");
    const userStops=pts.map(ft=>({
      name: ft.properties.name||ft.properties.desc||"Stop",
      lat: ft.geometry.coordinates[1],
      lon: ft.geometry.coordinates[0]
    }));
    stops=[WORK_START,...userStops,WORK_STOP];
    selectedRow=null;
    updateTable(); initSortable(); updateMarkers();
  }catch(err){ alert("Failed to import GPX: "+err.message); }
});

/* --- Sidebar Toggle --- */
toggleBtn.addEventListener('click',()=>{
  sidebar.classList.toggle('collapsed');
  toggleBtn.innerHTML=sidebar.classList.contains('collapsed')?'&#x25C0;':'&#x25B6;';
  setTimeout(()=>map.invalidateSize(),200);
});

/* --- Current Location --- */
document.getElementById("toggleLocation").addEventListener("click",()=>{
  if(locationWatch){
    navigator.geolocation.clearWatch(locationWatch);
    locationWatch=null;
    if(locationMarker){ map.removeLayer(locationMarker); locationMarker=null; }
    document.getElementById("toggleLocation").textContent="Enable Current Location";
  }else{
    locationWatch=navigator.geolocation.watchPosition(pos=>{
      const lat=pos.coords.latitude, lon=pos.coords.longitude;
      if(locationMarker){
        locationMarker.setLatLng([lat, lon]);
      }else{
        const crossIcon = L.divIcon({
          className:'current-location-icon',
          html:'<div style="color:red; font-weight:bold; font-size:20px;">&#x2716;</div>',
          iconSize:[20,20],
          iconAnchor:[10,10]
        });
        locationMarker = L.marker([lat, lon], {icon: crossIcon, title:"Current Location"}).addTo(map);
      }
    }, err=>console.warn(err), {enableHighAccuracy:true, maximumAge:0, timeout:5000});
    document.getElementById("toggleLocation").textContent="Disable Current Location";
  }
});

/* --- GPX Export --- */
exportBtn.addEventListener("click",()=>{
  let gpxHeader=`<?xml version="1.0" encoding="UTF-8"?>\n<gpx version="1.1"\n creator="Memory-Map"\n xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"\n xmlns="http://www.topografix.com/GPX/1/1"\n xmlns:xstyle="http://www.topografix.com/GPX/gpx_style/0/2"\n xmlns:xgarmin="http://www.garmin.com/xmlschemas/GpxExtensions/v3"\n xsi:schemaLocation="http://www.topografix.com/GPX/1/1 http://www.topografix.com/GPX/1/1/gpx.xsd http://www.topografix.com/GPX/gpx_style/0/2 http://www.topografix.com/GPX/gpx_style/0/2/gpx_style.xsd http://www.garmin.com/xmlschemas/GpxExtensions/v3 https://www8.garmin.com/xmlschemas/GpxExtensionsv3.xsd">\n`;
  let gpxBody="";
  let counter=1;
  stops.slice(1,-1).forEach(s=>{
    gpxBody+=`<wpt lat="${s.lat}" lon="${s.lon}">\n`;
    gpxBody+=`<time>${new Date().toISOString()}</time>\n`;
    gpxBody+=`<name>${escapeHtml(s.name)}</name>\n`;
    gpxBody+=`<src>mmid:${(counter++).toString(16).toUpperCase()}</src>\n`;
    gpxBody+=`<sym>Dot</sym>\n<type>Marks:Stops</type>\n<extensions>\n<xstyle:fill>\n<xstyle:color>0000ff</xstyle:color>\n</xstyle:fill>\n</extensions>\n</wpt>\n`;
  });
  let gpxFooter="</gpx>";
  const blob=new Blob([gpxHeader+gpxBody+gpxFooter],{type:"application/gpx+xml"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url; a.download="stops.gpx"; a.click();
  URL.revokeObjectURL(url);
});

/* --- Row selection & delete --- */
tbody.addEventListener("click", e => {
  const tr = e.target.closest("tr");
  if(!tr || tr.classList.contains("locked")) return;
  if(selectedRow) selectedRow.style.background="";
  selectedRow = tr;
  selectedRow.style.background="#ffd1b3";
});

document.getElementById("deleteStop").addEventListener("click", ()=>{
  if(!selectedRow) return;
  const idx = parseInt(selectedRow.dataset.index,10);
  stops.splice(idx,1);
  selectedRow = null;
  updateTable();
  updateMarkers();
  initSortable();
});

/* --- Screen Wake Lock --- */
async function requestWakeLock(){
  try{
    if('wakeLock' in navigator){
      wakeLock = await navigator.wakeLock.request('screen');
      wakeLock.addEventListener('release',()=>console.log('Wake lock released'));
      console.log('Wake lock active');
    }
  }catch(err){ console.warn('Wake Lock failed:', err); }
}
async function releaseWakeLock(){
  if(wakeLock){ await wakeLock.release(); wakeLock=null; }
}
setInterval(()=>requestWakeLock(), 300000);
document.addEventListener('visibilitychange', ()=>{
  if(document.visibilityState==='visible') requestWakeLock();
  else releaseWakeLock();
});

window.addEventListener('load', ()=>{
  requestWakeLock();
  sidebar.classList.remove('collapsed');
  toggleBtn.innerHTML='&#x25B6;';
  updateTable(); initSortable(); updateMarkers();
});
</script>
</body>
</html>
