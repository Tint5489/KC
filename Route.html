<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GPX Route Planner</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-gpx"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
  <style>
    body {
      margin: 0;
      display: flex;
      height: 100vh;
      font-family: Arial, sans-serif;
    }
    #map {
      flex: 3;
    }
    #sidebar {
      flex: 1;
      padding: 10px;
      background: #f8f9fa;
      overflow-y: auto;
      border-left: 1px solid #ddd;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      padding: 8px;
      border-bottom: 1px solid #ddd;
      text-align: left;
    }
    th {
      background: #007bff;
      color: white;
    }
    tr {
      cursor: grab;
    }
    tr.dragging {
      background: #e3f2fd;
    }
    .numbered-marker div {
      background: #007bff;
      color: white;
      border-radius: 50%;
      width: 28px;
      height: 28px;
      line-height: 28px;
      text-align: center;
      font-weight: bold;
      border: 2px solid white;
      box-shadow: 0 0 3px rgba(0,0,0,0.6);
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="sidebar">
    <h3>Stops</h3>
    <input type="file" id="gpxFile" accept=".gpx"><br><br>
    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>Stop Name</th>
        </tr>
      </thead>
      <tbody id="stops"></tbody>
    </table>
  </div>

<script>
  const map = L.map("map").setView([51.505, -0.09], 13);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19
  }).addTo(map);

  let stops = [];
  let routeLine = null;
  let markers = [];

  // Update marker numbers
  function updateMarkers() {
    markers.forEach(m => map.removeLayer(m));
    markers = [];
    stops.forEach((stop, i) => {
      const numberIcon = L.divIcon({
        className: "numbered-marker",
        html: `<div>${i + 1}</div>`,
        iconSize: [30, 30],
        iconAnchor: [15, 30]
      });
      const marker = L.marker([stop.lat, stop.lon], { icon: numberIcon })
        .addTo(map)
        .bindPopup(stop.name);
      markers.push(marker);
    });
  }

  // Build route polyline
  function buildRoute() {
    if (routeLine) map.removeLayer(routeLine);
    if (stops.length > 1) {
      routeLine = L.polyline(stops.map(s => [s.lat, s.lon]), {
        color: "blue",
        weight: 3
      }).addTo(map);
      map.fitBounds(routeLine.getBounds());
    }
    updateMarkers();
  }

  // Render stops in table
  function renderStopsTable() {
    const tbody = document.getElementById("stops");
    tbody.innerHTML = "";
    stops.forEach((stop, i) => {
      const tr = document.createElement("tr");
      tr.dataset.index = i;

      const tdNum = document.createElement("td");
      tdNum.textContent = i + 1;

      const tdName = document.createElement("td");
      tdName.textContent = stop.name;

      tr.appendChild(tdNum);
      tr.appendChild(tdName);
      tbody.appendChild(tr);
    });
  }

  // GPX file load
  document.getElementById("gpxFile").addEventListener("change", (e) => {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (evt) => {
      const gpxLayer = new L.GPX(evt.target.result, {
        async: true,
        marker_options: { startIconUrl: null, endIconUrl: null, shadowUrl: null }
      });

      gpxLayer.on("loaded", (evt) => {
        const gpx = evt.target;
        stops = [];
        gpx.getLayers().forEach(layer => {
          if (layer instanceof L.Marker) {
            const latlng = layer.getLatLng();
            const name = layer.getPopup()?.getContent() || `Stop ${stops.length + 1}`;
            stops.push({ name, lat: latlng.lat, lon: latlng.lng });
          }
        });
        renderStopsTable();
        buildRoute();
      });

      gpxLayer.addTo(map);
    };
    reader.readAsText(file);
  });

  // Make table sortable
  new Sortable(document.getElementById("stops"), {
    animation: 150,
    onEnd: () => {
      const newOrder = [];
      document.querySelectorAll("#stops tr").forEach(tr => {
        newOrder.push(stops[tr.dataset.index]);
      });
      stops = newOrder;
      renderStopsTable();
      buildRoute();
    }
  });
</script>
</body>
</html>
