<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Route Planner with Numbered Stops & Current Location</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css"/>

<style>
html, body { height:100%; margin:0; font-family:Arial,Helvetica,sans-serif; width:100vw; overflow:hidden; background:#fafbfc; }
#map { position:absolute; top:0; left:0; right:0; bottom:0; width:100vw; height:100vh; z-index:1; }

#sidebar { position: fixed; top:0; right:0; height:100vh; width:340px;
  background:#f9f9f9; border-left:1px solid #ccc; padding:14px; box-sizing:border-box;
  overflow:auto; z-index:1200; transition: transform .28s ease; transform: translateX(0); min-width:240px; max-width:420px; }
#sidebar.collapsed { transform: translateX(100%); }

#sidebarToggle { position: fixed; right:0; top:50%; transform:translateY(-50%);
  width:36px; height:54px; background:#007bff; color:#fff;
  display:flex; align-items:center; justify-content:center; font-size:22px;
  cursor:pointer; border-radius:6px 0 0 6px; z-index:20000; }

.table-container { background:#fff; border:2px solid #dadada; border-radius:6px;
  box-shadow:0 2px 8px -2px #bbb; padding:6px; overflow:auto; margin-top:10px; }

/* Smaller, compact table */
table { border-collapse:collapse; width:100%; font-size:13px; }
th, td { padding:4px 6px; border:1px solid #ddd; text-align:left; }
tr { cursor:grab; }
tr.dragging { background:#ffeeba; }

#routeInfo { font-weight:500; margin-top:10px; color:#333; }

#resizeHandle { height:36px; background:#eee; border-radius:6px;
  display:flex; align-items:center; justify-content:center;
  margin-top:8px; user-select:none; touch-action:none; }
#resizeHandle .hamb span { display:block; height:3px; width:28px; background:#666; margin:4px 0; border-radius:2px; }

/* Plain larger numbers for stops, no circles */
.leaflet-div-icon {
  background: none !important;
  border: none !important;
  box-shadow: none !important;
  font-weight: bold;
  font-size: 24px; /* larger number */
  text-align: center;
}

@media (max-width:820px){
  #sidebar { width:auto; min-width:200px; max-width:92vw; box-shadow:-6px 0 18px rgba(0,0,0,0.25); }
}
</style>
</head>
<body>

<div id="map"></div>
<div id="sidebarToggle">&#x25B6;</div>

<aside id="sidebar">
<h2 style="margin:6px 0 8px 0">Route Planner</h2>

<label for="fileInput">Import stops from GPX file:</label>
<input type="file" id="fileInput" accept=".gpx"/>

<div id="routeInfo">Total distance: 0 km / 0 mi, Estimated time: 0h 0m</div>

<div id="resizeHandle" title="Drag to resize table height"><div class="hamb"><span></span><span></span><span></span></div></div>

<div class="table-container" id="tableContainer" style="height:300px">
  <table id="stopsTable">
    <thead><tr><th>#</th><th>Stop</th></tr></thead>
    <tbody></tbody>
  </table>
</div>
</aside>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
<script src="https://unpkg.com/@mapbox/togeojson@0.16.0/togeojson.js"></script>

<script>
const WORK_START = { name:"Start", lat:54.971723, lon:-2.949500 };
const WORK_STOP  = { name:"End", lat:54.971730, lon:-2.949550 };
const DEFAULT_CENTER = [54.58303,-2.56954];
const DEFAULT_ZOOM = 6;

let stops = [WORK_START, WORK_STOP];
let routingControl = null;
let stopLabels = [];
let sortable = null;
let currentLocationMarker = null;

const sidebar = document.getElementById('sidebar');
const toggleBtn = document.getElementById('sidebarToggle');
const tbody = document.querySelector("#stopsTable tbody");
const routeInfoEl = document.getElementById("routeInfo");
const tableContainer = document.getElementById("tableContainer");
const resizeHandle = document.getElementById("resizeHandle");
const fileInput = document.getElementById("fileInput");

const map = L.map('map').setView(DEFAULT_CENTER, DEFAULT_ZOOM);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ attribution:'&copy; OpenStreetMap contributors' }).addTo(map);

// Table update
function updateTable(){
  tbody.innerHTML = "";
  stops.forEach((stop,i)=>{
    const row = document.createElement("tr");
    row.dataset.index = i;
    row.innerHTML = `<td>${i+1}</td><td>${stop.name}</td>`;
    tbody.appendChild(row);
  });
}

// Stop labels
function removeStopLabels(){
  stopLabels.forEach(l => map.removeLayer(l));
  stopLabels = [];
}

function addStopLabels(){
  removeStopLabels();
  stops.forEach((s,i)=>{
    let color = "#007bff"; 
    if(i === 0) color = "#007bff";       
    else if(i === stops.length - 1) color = "#ff0000"; 
    else color = "#28a745";             

    const label = L.marker([s.lat,s.lon], {
      icon: L.divIcon({
        className: 'leaflet-div-icon',
        html: `<span style="color:${color}">${i+1}</span>`,
        iconSize: [24, 24],
        iconAnchor: [12, 12]
      }),
      interactive: false
    }).addTo(map);
    stopLabels.push(label);
  });
}

// Table height
function resizeTableToFitRows(){
  const rowHeight = 34; 
  const headerHeight = 38; 
  const padding = 12; 
  const totalRows = stops.length;
  const newHeight = Math.min(headerHeight + totalRows * rowHeight + padding, 600); 
  tableContainer.style.height = newHeight + "px";
  setTimeout(()=>map.invalidateSize(), 100);
}

// Route
function updateRoute(fitBounds=false){
  if(routingControl){ map.removeControl(routingControl); routingControl=null; }
  if(stops.length<2){ routeInfoEl.textContent="Total distance: 0 km / 0 mi, Estimated time: 0h 0m"; removeStopLabels(); return; }

  const waypoints = stops.map(s=>L.latLng(s.lat,s.lon));
  routingControl = L.Routing.control({
    waypoints: waypoints,
    lineOptions: { styles: [{ color:'#007bff', weight:4, opacity:0.8 }] },
    addWaypoints: false,
    draggableWaypoints: false,
    show: false,
    fitSelectedRoutes: false,
    createMarker: function() { return null; } 
  }).addTo(map);

  addStopLabels();

  routingControl.on('routesfound', e=>{
    const route = e.routes[0];
    if(route && route.summary){
      const distKm = (route.summary.totalDistance/1000).toFixed(1);
      const distMi = (route.summary.totalDistance * 0.000621371).toFixed(1);
      const totalSec = route.summary.totalTime;
      const hours = Math.floor(totalSec / 3600);
      const mins = Math.round((totalSec % 3600) / 60);
      routeInfoEl.textContent = `Total distance: ${distKm} km / ${distMi} mi, Estimated time: ${hours}h ${mins}m`;
    }
  });

  if(fitBounds){
    const bounds = L.latLngBounds(stops.map(s => [s.lat, s.lon]));
    map.fitBounds(bounds, { padding: [50,50] });
  }
}

// Sortable
function initSortable(){
  if(sortable) sortable.destroy();
  sortable = Sortable.create(tbody,{
    handle:'td', animation:160,
    onEnd:function(){
      const newStops=[];
      tbody.querySelectorAll('tr').forEach(row=>{
        const oldIndex=parseInt(row.dataset.index,10);
        newStops.push(stops[oldIndex]);
      });
      stops = [WORK_START,...newStops.slice(1,-1),WORK_STOP];
      updateTable(); updateRoute(false);
      resizeTableToFitRows();
      initSortable();
    }
  });
}

// File input
fileInput.addEventListener("click", () => {
  stops = [WORK_START, WORK_STOP];
  updateTable();
  removeStopLabels();
  updateRoute(false);
  resizeTableToFitRows();
  fileInput.value = ''; 
});

fileInput.addEventListener("change", async ev=>{
  const f = ev.target.files && ev.target.files[0]; 
  if(!f) return;
  try{
    const text = await f.text();
    const xml = new DOMParser().parseFromString(text,"text/xml");
    const geojson = toGeoJSON.gpx(xml);
    const pts = geojson.features.filter(ft=>ft.geometry && ft.geometry.type==="Point");
    const userStops = pts.map(ft=>({ name: ft.properties.name||ft.properties.desc||"Stop", lat: ft.geometry.coordinates[1], lon: ft.geometry.coordinates[0] }));
    stops=[WORK_START,...userStops,WORK_STOP];
    updateTable(); initSortable(); resizeTableToFitRows(); updateRoute(true);
    fileInput.value = ''; 
  }catch(err){ alert("Failed to import GPX: "+err.message); }
});

// Sidebar toggle
toggleBtn.addEventListener('click',()=>{
  sidebar.classList.toggle('collapsed');
  sidebar.style.transform='';
  toggleBtn.innerHTML = sidebar.classList.contains('collapsed')?'&#x25C0;':'&#x25B6;';
  setTimeout(()=>map.invalidateSize(),200);
});
window.addEventListener('load',()=>{ sidebar.classList.remove('collapsed'); toggleBtn.innerHTML='&#x25B6;'; });

// Table resize handle
let resizing=false, startY=0, startH=0;
function startResize(e){ resizing=true; startY=e.clientY; startH=tableContainer.offsetHeight; document.addEventListener('pointermove',onResize); document.addEventListener('pointerup',stopResize); e.preventDefault();}
function onResize(e){ if(!resizing) return; let newH=startH+startY-e.clientY; newH=Math.max(120,Math.min(800,newH)); tableContainer.style.height=newH+'px'; setTimeout(()=>map.invalidateSize(),50);}
function stopResize(){ resizing=false; document.removeEventListener('pointermove',onResize); document.removeEventListener('pointerup',stopResize); setTimeout(()=>map.invalidateSize(),100);}
resizeHandle.addEventListener('pointerdown',startResize);

// Current location
function updateCurrentLocation() {
  if (!navigator.geolocation) return console.warn("Geolocation not supported");
  navigator.geolocation.getCurrentPosition(pos => {
    const lat = pos.coords.latitude;
    const lon = pos.coords.longitude;

    if (!currentLocationMarker) {
      currentLocationMarker = L.marker([lat, lon], {
        title: "You are here",
        icon: L.icon({
          iconUrl: "https://cdn-icons-png.flaticon.com/512/64/64113.png",
          iconSize: [24, 24],
          iconAnchor: [12, 12]
        })
      }).addTo(map);
    } else {
      currentLocationMarker.setLatLng([lat, lon]);
    }
  }, err => console.warn("Geolocation error:", err), { enableHighAccuracy: true });
}

// Initial location and update every 5 minutes
updateCurrentLocation();
setInterval(updateCurrentLocation, 5 * 60 * 1000);

updateTable(); initSortable(); resizeTableToFitRows(); updateRoute(false);
</script>
</body>
</html>
