<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GPX Route Viewer</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
  html, body { height: 100%; margin: 0; }
  body {
    display: flex;
    flex-direction: row;
    height: 100vh;
    font-family: Arial, Helvetica, sans-serif;
    overflow: hidden;
    position: relative;
  }

  #map { flex: 3; min-width: 0; }

  #sidebar {
    flex: 1;
    border-left: 1px solid #ccc;
    padding: 10px;
    background: #f9f9f9;
    display: flex;
    flex-direction: column;
    min-width: 240px;
    position: relative;
  }

  #sidebar h2 { margin-top: 0; }

  /* Toggle button */
  #toggleSidebar {
    position: absolute;
    top: 10px;
    right: 10px;
    z-index: 999;
    background: white;
    border: 1px solid #ccc;
    border-radius: 4px;
    cursor: pointer;
    padding: 4px 8px;
    font-size: 18px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
  }

  /* Collapse state */
  body.collapsed #sidebar {
    width: 60px;
    min-width: 60px;
    padding: 0;
    overflow: visible;
  }
  body.collapsed #sidebar h2,
  body.collapsed #sidebar input,
  body.collapsed #resizeHandle,
  body.collapsed #downloadGpxBtn,
  body.collapsed th:nth-child(2),
  body.collapsed td:nth-child(2) {
    display: none;
  }
  body.collapsed .table-container {
    height: auto !important;
    max-height: none !important;
    border: none;
    box-shadow: none;
  }

  /* Resize handle */
  #resizeHandle {
    height: 40px;
    background: #eee;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: row-resize;
    user-select: none;
    touch-action: none;
    margin: 8px 0;
    border-radius: 6px;
  }
  #resizeHandle .hamb span {
    display: block;
    height: 4px;
    width: 30px;
    background: #666;
    margin: 5px 0;
    border-radius: 2px;
  }

  .table-container {
    width: 100%;
    overflow-x: auto;
    overflow-y: scroll;
    -webkit-overflow-scrolling: touch;
    height: 300px;
    max-height: 400px;
    min-height: 120px;
    background: white;
    margin-bottom: 14px;
    border-radius: 4px;
    border: 2px solid #dadada;
    box-shadow: 0 2px 8px -2px #bbb;
    padding-bottom: 10px;
  }
  .table-container::-webkit-scrollbar { width: 16px; background: #e3e3e3; border-radius: 8px; }
  .table-container::-webkit-scrollbar-thumb { background: #007bff; border-radius: 8px; border: 4px solid #e3e3e3; }

  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 16px;
    min-width: 260px;
    background: white;
  }
  th, td {
    padding: 10px 8px;
    border: 1px solid #ddd;
    text-align: left;
    font-size: 15px;
    background: white;
  }
  th:first-child, td:first-child {
    width: 1%;
    white-space: nowrap;
    text-align: center;
  }
  tr { cursor: grab; }

  .numbered-marker div {
    background: #007bff;
    color: white;
    border-radius: 50%;
    width: 26px;
    height: 26px;
    text-align: center;
    line-height: 26px;
    font-weight: bold;
    border: 2px solid white;
  }

  .stop-label {
    background: white;
    padding: 2px 5px;
    border-radius: 4px;
    border: 1px solid #ccc;
    font-size: 12px;
    color: #333;
  }

  button {
    margin-top: auto;
    padding: 12px 16px;
    font-size: 16px;
    cursor: pointer;
    width: 100%;
    box-sizing: border-box;
  }

  .updated-row {
    background: #e3f7ff;
    transition: background 0.5s;
  }

  @media (max-width: 820px) {
    body { flex-direction: column; }
    #map { height: 40vh; min-height: 180px; }
    .table-container { max-height: 40vh; height: 38vh; }
    #toggleSidebar { top: 6px; right: 6px; font-size: 16px; padding: 4px; }
  }
</style>
</head>
<body>

<div id="map"></div>

<div id="sidebar">
  <button id="toggleSidebar">⏴</button>
  <h2>Stops</h2>
  <input type="file" id="gpxFile" accept=".gpx"><br><br>
  <div id="resizeHandle"><div class="hamb"><span></span><span></span><span></span></div></div>
  <div class="table-container" id="tableContainer">
    <table id="stopsTable">
      <thead><tr><th>#</th><th>Name</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
  <button id="downloadGpxBtn">Download Reordered GPX</button>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/togeojson"></script>
<script src="https://unpkg.com/sortablejs@1.15.0/Sortable.min.js"></script>

<script>
const map = L.map('map').setView([51.505, -0.09], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

let stops = [], markers = [], sortable = null;
const tbody = document.querySelector("#stopsTable tbody");
const downloadBtn = document.getElementById("downloadGpxBtn");
const tableContainer = document.getElementById("tableContainer");
const resizeHandle = document.getElementById("resizeHandle");
const toggleBtn = document.getElementById("toggleSidebar");

document.getElementById("gpxFile").addEventListener("change", handleFile);

function handleFile(e) {
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = function(evt){
    const parser = new DOMParser();
    const xmlDoc = parser.parseFromString(evt.target.result, "text/xml");
    const geojson = toGeoJSON.gpx(xmlDoc);
    stops = geojson.features.filter(f => f.geometry.type === "Point").map((f,i)=>({
      name: f.properties.name || `Stop ${i+1}`,
      lat: f.geometry.coordinates[1],
      lon: f.geometry.coordinates[0]
    }));
    updateTable(); initSortable(); updateMarkers();
  }
  reader.readAsText(file);
}

function updateTable() {
  tbody.innerHTML = "";
  stops.forEach((stop,i)=>{
    const row = document.createElement("tr");
    row.dataset.index = i;
    row.innerHTML = `<td>${i+1}</td><td>${stop.name}</td>`;
    row.classList.add("updated-row");
    tbody.appendChild(row);
    setTimeout(()=>row.classList.remove("updated-row"),500);
  });
}

function updateMarkers() {
  markers.forEach(m=>map.removeLayer(m));
  markers = [];
  stops.forEach((stop,i)=>{
    const icon = L.divIcon({
      className:"numbered-marker",
      html:`<div>${i+1}</div>`,
      iconSize:[30,30],
      iconAnchor:[15,30]
    });
    const marker = L.marker([stop.lat,stop.lon],{icon}).addTo(map)
      .bindTooltip(`${i+1}. ${stop.name}`,{permanent:true,direction:"top",offset:[0,-35]});
    markers.push(marker);
  });
  if(markers.length){
    const group = L.featureGroup(markers);
    map.fitBounds(group.getBounds(),{padding:[40,40]});
  }
}

function initSortable(){
  if(sortable) sortable.destroy();
  sortable = Sortable.create(tbody,{
    animation:150,
    handle:"td:first-child", // drag only from number column
    onEnd: function(){
      const newStops = [];
      tbody.querySelectorAll("tr").forEach(row=>{
        const oldIndex = parseInt(row.dataset.index,10);
        newStops.push(stops[oldIndex]);
      });
      stops = newStops;
      updateTable(); updateMarkers(); initSortable();
    }
  });
}

downloadBtn.addEventListener("click", ()=>{
  const now = new Date();
  const filename = `Stops-${now.getFullYear()}-${(now.getMonth()+1).toString().padStart(2,'0')}-${now.getDate().toString().padStart(2,'0')}-${now.getHours().toString().padStart(2,'0')}-${now.getMinutes().toString().padStart(2,'0')}.gpx`;
  let gpx = `<?xml version="1.0" encoding="UTF-8"?><gpx version="1.1" creator="GPXRouteViewer" xmlns="http://www.topografix.com/GPX/1/1">`;
  stops.forEach((s,i)=>{
    gpx += `<wpt lat="${s.lat}" lon="${s.lon}"><name>${i+1}. ${s.name}</name></wpt>`;
  });
  gpx += `</gpx>`;
  const blob = new Blob([gpx], {type:"application/gpx+xml"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = filename; document.body.appendChild(a); a.click();
  document.body.removeChild(a); URL.revokeObjectURL(url);
});

// Pointer Events resize
let startY=0, startHeight=0, resizing=false;
function initResize(e){ resizing=true; startY=e.clientY; startHeight=parseInt(window.getComputedStyle(tableContainer).height,10);
  document.addEventListener("pointermove", doResize); document.addEventListener("pointerup", stopResize); e.preventDefault();
}
function doResize(e){ if(!resizing) return; const dy=startY-e.clientY; let newHeight=startHeight+dy; newHeight=Math.max(120,Math.min(700,newHeight));
  tableContainer.style.height=newHeight+"px"; tableContainer.style.maxHeight=newHeight+"px"; e.preventDefault();
}
function stopResize(){ if(!resizing) return; resizing=false; document.removeEventListener("pointermove", doResize); document.removeEventListener("pointerup", stopResize);
  setTimeout(()=>map.invalidateSize(),150);
}
resizeHandle.addEventListener("pointerdown", initResize);

// Toggle sidebar collapse/expand
toggleBtn.addEventListener("click", ()=>{
  document.body.classList.toggle("collapsed");
  toggleBtn.textContent = document.body.classList.contains("collapsed") ? "⏵" : "⏴";
  setTimeout(()=>map.invalidateSize(),200);
});
</script>

</body>
</html>
