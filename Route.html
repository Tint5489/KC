<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GPX Route Planner</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
  <style>
    body {
      margin: 0;
      display: flex;
      height: 100vh;
      font-family: Arial, sans-serif;
    }
    #map {
      flex: 3;
    }
    #sidebar {
      flex: 1;
      padding: 10px;
      background: #f8f9fa;
      overflow-y: auto;
      border-left: 1px solid #ddd;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      padding: 8px;
      border-bottom: 1px solid #ddd;
      text-align: left;
    }
    th {
      background: #007bff;
      color: white;
    }
    tr {
      cursor: grab;
    }
    tr.dragging {
      background: #e3f2fd;
    }
    .numbered-marker div {
      background: #007bff;
      color: white;
      border-radius: 50%;
      width: 28px;
      height: 28px;
      line-height: 28px;
      text-align: center;
      font-weight: bold;
      border: 2px solid white;
      box-shadow: 0 0 3px rgba(0,0,0,0.6);
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="sidebar">
    <h3>Stops</h3>
    <input type="file" id="gpxFile" accept=".gpx"><br><br>
    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>Stop Name</th>
        </tr>
      </thead>
      <tbody id="stops"></tbody>
    </table>
  </div>

<script>
  const map = L.map("map").setView([51.505, -0.09], 13);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19
  }).addTo(map);

  let stops = [];
  let routeLine = null;
  let markers = [];

  function updateMarkers() {
    markers.forEach(m => map.removeLayer(m));
    markers = [];
    stops.forEach((stop, i) => {
      const numberIcon = L.divIcon({
        className: "numbered-marker",
        html: `<div>${i + 1}</div>`,
        iconSize: [30, 30],
        iconAnchor: [15, 30]
      });
      const marker = L.marker([stop.lat, stop.lon], { icon: numberIcon })
        .addTo(map)
        .bindPopup(stop.name);
      markers.push(marker);
    });
    if (markers.length > 0) {
      const group = L.featureGroup(markers);
      map.fitBounds(group.getBounds(), { padding: [40, 40] });
    }
  }

  function buildRoute() {
    if (routeLine) map.removeLayer(routeLine);
    if (stops.length > 1) {
      routeLine = L.polyline(stops.map(s => [s.lat, s.lon]), {
        color: "blue",
        weight: 3
      }).addTo(map);
      map.fitBounds(routeLine.getBounds(), { padding: [40, 40] });
    }
    updateMarkers();
  }

  function renderStopsTable() {
    const tbody = document.getElementById("stops");
    tbody.innerHTML = "";
    stops.forEach((stop, i) => {
      const tr = document.createElement("tr");
      tr.dataset.index = i;

      const tdNum = document.createElement("td");
      tdNum.textContent = i + 1;

      const tdName = document.createElement("td");
      tdName.textContent = stop.name;

      tr.appendChild(tdNum);
      tr.appendChild(tdName);
      tbody.appendChild(tr);
    });
  }

  // GPX file load
  document.getElementById("gpxFile").addEventListener("change", (e) => {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (evt) => {
      const parser = new DOMParser();
      const xmlDoc = parser.parseFromString(evt.target.result, "application/xml");

      stops = [];
      // First try waypoints <wpt>
      xmlDoc.querySelectorAll("wpt").forEach((wpt, idx) => {
        const lat = parseFloat(wpt.getAttribute("lat"));
        const lon = parseFloat(wpt.getAttribute("lon"));
        const name = wpt.querySelector("name")?.textContent || `Stop ${idx + 1}`;
        stops.push({ name, lat, lon });
      });

      // If no waypoints, use trackpoints <trkpt>
      if (stops.length === 0) {
        xmlDoc.querySelectorAll("trkpt").forEach((pt, idx) => {
          const lat = parseFloat(pt.getAttribute("lat"));
          const lon = parseFloat(pt.getAttribute("lon"));
          stops.push({ name: `Stop ${idx + 1}`, lat, lon });
        });
      }

      renderStopsTable();
      buildRoute();
    };
    reader.readAsText(file);
  });

  // Make table sortable
  new Sortable(document.getElementById("stops"), {
    animation: 150,
    onEnd: () => {
      const newOrder = [];
      document.querySelectorAll("#stops tr").forEach(tr => {
        newOrder.push(stops[tr.dataset.index]);
      });
      stops = newOrder;
      renderStopsTable();
      buildRoute();
    }
  });
</script>
</body>
</html>
