<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>GPX Route Viewer</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
  body {
    margin: 0;
    display: flex;
    height: 100vh;
    font-family: Arial, sans-serif;
    flex-direction: row;
  }
  #map { flex: 3; min-width: 0; }
  #sidebar {
    flex: 1;
    border-left: 1px solid #ccc;
    padding: 10px;
    overflow-y: auto;
    background: #f9f9f9;
    min-width: 240px;
    transition: transform 0.3s ease;
    z-index: 1000;
  }
  #sidebar.collapsed {
    transform: translateX(100%);
  }
  #sidebar h2 { margin-top: 0; }

  .table-container {
    width: 100%;
    overflow-x: auto;
    overflow-y: auto;
    max-height: 400px;
    background: white;
    margin-bottom: 14px;
    border-radius: 4px;
    border: 2px solid #dadada;
    box-shadow: 0 2px 8px -2px #bbb;
    padding-bottom: 10px;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 16px;
    min-width: 260px;
    background: white;
  }
  th, td {
    padding: 10px 8px;
    border: 1px solid #ddd;
    text-align: left;
    font-size: 15px;
  }
  tr { cursor: grab; }
  .handle {
    cursor: grab;
    font-size: 20px;
    text-align: center;
  }
  .numbered-marker div {
    background: #007bff;
    color: white;
    border-radius: 50%;
    width: 26px;
    height: 26px;
    text-align: center;
    line-height: 26px;
    font-weight: bold;
    border: 2px solid white;
  }
  .stop-label {
    background: white;
    padding: 2px 5px;
    border-radius: 4px;
    border: 1px solid #ccc;
    font-size: 12px;
    color: #333;
  }
  button {
    margin-top: 10px;
    padding: 12px 16px;
    font-size: 16px;
    cursor: pointer;
    width: 100%;
    box-sizing: border-box;
  }

  /* Persistent toggle arrow */
  #sidebarToggle {
    position: fixed;
    right: 0;
    top: 50%;
    transform: translateY(-50%);
    width: 30px;
    height: 50px;
    background: #007bff;
    color: white;
    font-size: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 4px 0 0 4px;
    cursor: pointer;
    z-index: 20000; /* Always above */
  }

  /* Responsive styles */
  @media (max-width: 800px) {
    body { flex-direction: column; }
    #sidebar {
      position: absolute;
      top: 0; right: 0; bottom: 0;
      width: 70%;
      max-width: 320px;
      min-width: 240px;
    }
    #map { flex: 1; height: 100vh; }
  }
</style>
</head>
<body>
<div id="map"></div>
<div id="sidebar">
  <h2>Stops</h2>
  <input type="file" id="gpxFile" accept=".gpx"><br><br>
  <div class="table-container" id="tableContainer">
    <table id="stopsTable">
      <thead>
        <tr><th></th><th>#</th><th>Name</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  <button id="downloadGpxBtn">Download Reordered GPX</button>
</div>
<div id="sidebarToggle">&#x25B6;</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/togeojson"></script>
<script src="https://unpkg.com/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
  const map = L.map('map').setView([51.505, -0.09], 13);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19
  }).addTo(map);

  let stops = [];
  let markers = [];
  let routeLine = null;
  let sortable = null;

  const tbody = document.querySelector("#stopsTable tbody");
  const downloadBtn = document.getElementById("downloadGpxBtn");
  const sidebar = document.getElementById("sidebar");
  const toggleBtn = document.getElementById("sidebarToggle");

  document.getElementById("gpxFile").addEventListener("change", handleFile);

  function handleFile(e) {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(event) {
      const parser = new DOMParser();
      const xmlDoc = parser.parseFromString(event.target.result, "text/xml");
      const geojson = toGeoJSON.gpx(xmlDoc);

      stops = geojson.features
        .filter(f => f.geometry.type === "Point")
        .map((f,i) => ({
          name: f.properties.name || `Stop ${i+1}`,
          lat: f.geometry.coordinates[1],
          lon: f.geometry.coordinates[0]
        }));

      updateTable();
      initSortable();
      updateMarkers();
      updateRoute();
    };
    reader.readAsText(file);
  }

  function updateTable() {
    tbody.innerHTML = "";
    stops.forEach((stop, i) => {
      const row = document.createElement("tr");
      row.dataset.index = i;
      row.innerHTML = `
        <td class="handle">&#9776;</td>
        <td>${i+1}</td>
        <td>${stop.name}</td>`;
      tbody.appendChild(row);
    });
  }

  function updateMarkers() {
    markers.forEach(m => map.removeLayer(m));
    markers = [];
    stops.forEach((stop, i) => {
      const numberIcon = L.divIcon({
        className: "numbered-marker",
        html: `<div>${i+1}</div>`,
        iconSize: [30,30],
        iconAnchor: [15,30]
      });
      const marker = L.marker([stop.lat, stop.lon], { icon: numberIcon })
        .addTo(map)
        .bindTooltip(`${i+1}. ${stop.name}`, { 
          permanent: true,
          direction: "top",
          offset: [0,-35],
          className: "stop-label"
        });
      markers.push(marker);
    });
    if (markers.length > 0) {
      const group = L.featureGroup(markers);
      map.fitBounds(group.getBounds(), { padding: [40,40] });
    }
  }

  function updateRoute() {
    if (routeLine) map.removeLayer(routeLine);
    if (stops.length > 1) {
      const latlngs = stops.map(s => [s.lat, s.lon]);
      routeLine = L.polyline(latlngs, { color: "blue", weight: 3 }).addTo(map);
      map.fitBounds(routeLine.getBounds(), { padding: [40,40] });
    }
  }

  function initSortable() {
    if (sortable) sortable.destroy();
    sortable = Sortable.create(tbody, {
      handle: ".handle",
      animation: 150,
      onEnd: function() {
        const newStops = [];
        tbody.querySelectorAll("tr").forEach(row => {
          const oldIndex = parseInt(row.dataset.index, 10);
          newStops.push(stops[oldIndex]);
        });
        stops = newStops;
        updateTable();
        updateMarkers();
        updateRoute();
        initSortable();
      }
    });
  }

  function downloadGPX() {
    const now = new Date();
    const filename = `Stops-${now.getFullYear()}-${(now.getMonth()+1).toString().padStart(2,'0')}-${now.getDate().toString().padStart(2,'0')}-${now.getHours().toString().padStart(2,'0')}-${now.getMinutes().toString().padStart(2,'0')}.gpx`;

    let gpx = `<?xml version="1.0" encoding="UTF-8"?>
<gpx version="1.1" creator="GPXRouteViewer" xmlns="http://www.topografix.com/GPX/1/1">`;

    stops.forEach((s, i) => {
      gpx += `
  <wpt lat="${s.lat}" lon="${s.lon}">
    <name>${i+1}. ${s.name}</name>
  </wpt>`;
    });

    gpx += `
</gpx>`;

    const blob = new Blob([gpx], { type: "application/gpx+xml" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  downloadBtn.addEventListener("click", downloadGPX);

  // Sidebar toggle logic
  toggleBtn.addEventListener("click", () => {
    sidebar.classList.toggle("collapsed");
    toggleBtn.innerHTML = sidebar.classList.contains("collapsed") ? "&#x25C0;" : "&#x25B6;";
    setTimeout(() => map.invalidateSize(), 200);
  });

  // Set initial arrow direction on load
  if (window.innerWidth < 820) {
    sidebar.classList.add("collapsed");
    toggleBtn.innerHTML = "&#x25C0;";
  } else {
    toggleBtn.innerHTML = "&#x25B6;";
  }
</script>
</body>
</html>
