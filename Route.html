<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Route Planner with Distance & Time</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
<style>
  html, body { height:100%; margin:0; font-family:Arial,sans-serif; }
  body { display:flex; flex-direction:row; background:#fafbfc; }
  #map { flex:1; height:100vh; min-width:300px; }
  #controls {
    width: 320px; min-width:260px; max-width:360px;
    overflow-y:auto;
    border-left:1px solid #ccc;
    padding:20px 16px;
    background:#f9f9f9;
    box-sizing:border-box;
    display:flex; flex-direction:column; gap:12px;
  }
  table { width:100%; border-collapse:collapse; margin-top:10px; }
  th, td { border:1px solid #ddd; padding:6px; text-align:left; }
  th { background:#f4f4f4; font-weight:600; }
  tr.dragging { background:#ffeeba; }
  button, select { padding:6px 10px; border-radius:5px; border:1px solid #bbb; font-size:1rem; background:#fff; }
  #routeInfo { font-weight:500; margin-top:10px; color:#333; }
  @media (max-width:700px){
    body { flex-direction:column; }
    #controls { width:100vw; border-left:none; border-top:1px solid #ccc; }
    #map { min-height:300px; }
  }
</style>
</head>
<body>

<div id="map" aria-label="Map"></div>

<div id="controls" role="region" aria-label="Route controls">
  <label for="fileInput">Import stops from GPX file:</label>
  <input type="file" id="fileInput" accept=".gpx" aria-label="Load GPX file"/>
  
  <div id="routeInfo">Total distance: 0 km, Estimated time: 0h 0m</div>

  <table id="stopsTable" aria-label="Stops list">
    <thead>
      <tr><th>#</th><th>Stop</th></tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
<script src="https://unpkg.com/@mapbox/togeojson@0.16.0/togeojson.js"></script>

<script>
// --- Constants ---
const WORK_STOP = { name:"BlendBetter", lat:54.971723, lon:-2.949500 };
const DEFAULT_CENTER = [54.58303,-2.56954];
const DEFAULT_ZOOM = 6;

// --- State ---
let stops = [WORK_STOP, WORK_STOP];
let markers = [];
let routingControl = null;
let sortable = null;

// --- DOM refs ---
const tbody = document.querySelector("#stopsTable tbody");
const loadingEl = document.getElementById("loading");
const routeInfoEl = document.getElementById("routeInfo");

// --- Map ---
const map = L.map('map', { attributionControl:true }).setView(DEFAULT_CENTER, DEFAULT_ZOOM);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution:'&copy; OpenStreetMap contributors'
}).addTo(map);

// --- Table Update ---
function updateTable() {
  tbody.innerHTML = "";
  stops.forEach((stop, i) => {
    const row = document.createElement("tr");
    row.dataset.index = i;
    row.innerHTML = `<td>${i+1}</td><td>${stop.name}</td>`;
    tbody.appendChild(row);
  });
}

// --- Marker Update ---
function updateMarkers() {
  markers.forEach(m => map.removeLayer(m));
  markers = stops.map((s, i) => 
    L.marker([s.lat, s.lon]).addTo(map).bindTooltip(`${i+1}. ${s.name}`, { permanent:true })
  );
  updateRoute();
}

// --- Route Update ---
function updateRoute() {
  if(routingControl){
    map.removeControl(routingControl);
    routingControl = null;
  }
  if(stops.length<2){
    routeInfoEl.textContent = "Total distance: 0 km, Estimated time: 0h 0m";
    return;
  }

  const waypoints = stops.map(s => L.latLng(s.lat, s.lon));
  routingControl = L.Routing.control({
    waypoints,
    lineOptions:{ styles:[{ color:'#007bff', weight:4, opacity:0.8 }] },
    addWaypoints:false,
    draggableWaypoints:false,
    show:false,
    fitSelectedRoutes:false
  }).addTo(map);

  routingControl.on('routesfound', function(e) {
    const route = e.routes[0];
    if(route && route.summary){
      const distKm = (route.summary.totalDistance/1000).toFixed(1);
      let totalSec = route.summary.totalTime;
      const hours = Math.floor(totalSec/3600);
      const mins = Math.round((totalSec % 3600)/60);
      routeInfoEl.textContent = `Total distance: ${distKm} km, Estimated time: ${hours}h ${mins}m`;
    }
  });
}

// --- Sortable Init ---
function initSortable(){
  if(sortable) sortable.destroy();
  sortable = Sortable.create(tbody, {
    handle:'td', // whole row draggable
    animation:160,
    onEnd: function(){
      const newStops = [];
      tbody.querySelectorAll('tr').forEach(row=>{
        const oldIndex = parseInt(row.dataset.index,10);
        newStops.push(stops[oldIndex]);
      });
      stops = [WORK_STOP, ...newStops.slice(1,-1), WORK_STOP];
      updateTable();
      updateMarkers();
      initSortable();
    }
  });
}

// --- File Import ---
document.getElementById("fileInput").addEventListener("change", async ev=>{
  const f = ev.target.files && ev.target.files[0];
  if(!f) return;
  try{
    const text = await f.text();
    const xml = new DOMParser().parseFromString(text,"text/xml");
    const geojson = toGeoJSON.gpx(xml);
    const pts = geojson.features.filter(ft=>ft.geometry && ft.geometry.type==="Point");
    const userStops = pts.map(ft=>({
      name: ft.properties.name || ft.properties.desc || "Stop",
      lat: ft.geometry.coordinates[1],
      lon: ft.geometry.coordinates[0]
    }));
    stops = [WORK_STOP, ...userStops, WORK_STOP];
    updateTable(); initSortable(); updateMarkers();
  }catch(err){
    alert("Failed to import GPX: "+err.message);
  }
});

// --- Initialize ---
updateTable(); initSortable(); updateMarkers();
</script>

</body>
</html>
