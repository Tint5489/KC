<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GPX Route Viewer</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
  body {
    margin: 0;
    display: flex;
    height: 100vh;
    font-family: Arial, sans-serif;
    flex-direction: row;
  }
  #map { flex: 3; min-width: 0; }
  #sidebar {
    flex: 1;
    border-left: 1px solid #ccc;
    padding: 10px;
    overflow-y: auto;
    background: #f9f9f9;
    min-width: 240px;
  }
  #sidebar h2 { margin-top: 0; }
  .table-container {
    width: 100%;
    overflow-x: auto;
    overflow-y: scroll !important;
    -webkit-overflow-scrolling: touch;
    max-height: 400px;
    background: white;
    margin-bottom: 14px;
    border-radius: 4px;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 16px;
    min-width: 260px;
    background: white;
    /* table-layout: auto; <-- Let columns size dynamically */
  }
  th, td {
    padding: 10px 8px;
    border: 1px solid #ddd;
    text-align: left;
    font-size: 15px;
    background: white;
  }
  th:first-child, td:first-child {
    position: sticky;
    left: 0;
    background: #f4f7fa;
    z-index: 2;
    box-shadow: 2px 0 8px -2px #bbb;
    width: 1%;
    white-space: nowrap;
    text-align: right;
  }
  th:nth-child(2), td:nth-child(2) {
    width: auto;
    white-space: nowrap;
    text-align: left;
  }
  tr { cursor: grab; }
  .numbered-marker div {
    background: #007bff;
    color: white;
    border-radius: 50%;
    width: 26px;
    height: 26px;
    text-align: center;
    line-height: 26px;
    font-weight: bold;
    border: 2px solid white;
  }
  .stop-label {
    background: white;
    padding: 2px 5px;
    border-radius: 4px;
    border: 1px solid #ccc;
    font-size: 12px;
    color: #333;
  }
  button {
    margin-top: 10px;
    padding: 12px 16px;
    font-size: 16px;
    cursor: pointer;
    width: 100%;
    box-sizing: border-box;
  }
  .updated-row {
    background: #e3f7ff;
    transition: background 0.5s;
  }
  /* Responsive styles */
  @media (max-width: 800px) {
    body {
      flex-direction: column;
    }
    #sidebar {
      min-width: 0;
      width: 100vw;
      border-left: none;
      border-top: 1px solid #ccc;
      padding: 14px 8px;
    }
    #map {
      flex: 2;
      min-height: 300px;
      height: 40vh;
    }
    .table-container {
      margin-bottom: 8px;
      max-height: 340px;
    }
    th, td {
      padding: 12px 6px;
      font-size: 16px;
    }
  }
  @media (max-width: 600px) {
    table {
      min-width: 300px;
    }
    th, td {
      font-size: 14px;
    }
    .table-container {
      max-height: 220px;
    }
  }
  @media (max-width: 500px) {
    table, th, td {
      font-size: 14px;
    }
    button {
      font-size: 15px;
      padding: 10px;
    }
    #sidebar h2 {
      font-size: 18px;
    }
    .table-container {
      max-height: 160px;
    }
  }
</style>
</head>
<body>
<div id="map"></div>
<div id="sidebar">
  <h2>Stops</h2>
  <input type="file" id="gpxFile" accept=".gpx"><br><br>
  <div class="table-container">
    <table id="stopsTable">
      <thead>
        <tr><th>#</th><th>Name</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  <button id="downloadGpxBtn">Download Reordered GPX</button>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/togeojson"></script>
<script src="https://unpkg.com/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
  const map = L.map('map').setView([51.505, -0.09], 13);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

  let stops = [];
  let markers = [];
  let sortable = null;

  const tbody = document.querySelector("#stopsTable tbody");
  const downloadBtn = document.getElementById("downloadGpxBtn");

  document.getElementById("gpxFile").addEventListener("change", handleFile);

  function handleFile(e) {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(event) {
      const parser = new DOMParser();
      const xmlDoc = parser.parseFromString(event.target.result, "text/xml");
      const geojson = toGeoJSON.gpx(xmlDoc);

      stops = geojson.features
        .filter(f => f.geometry.type === "Point")
        .map((f,i) => ({
          name: f.properties.name || `Stop ${i+1}`,
          lat: f.geometry.coordinates[1],
          lon: f.geometry.coordinates[0]
        }));

      updateTable();
      initSortable();
      updateMarkers();
    };
    reader.readAsText(file);
  }

  function updateTable() {
    tbody.innerHTML = "";
    stops.forEach((stop, i) => {
      const row = document.createElement("tr");
      row.dataset.index = i;
      row.innerHTML = `<td>${i+1}</td><td>${stop.name}</td>`;
      row.classList.add("updated-row");
      tbody.appendChild(row);
      setTimeout(() => row.classList.remove("updated-row"), 500);
    });
  }

  function updateMarkers() {
    markers.forEach(m => map.removeLayer(m));
    markers = [];
    stops.forEach((stop, i) => {
      const numberIcon = L.divIcon({
        className: "numbered-marker",
        html: `<div>${i+1}</div>`,
        iconSize: [30,30],
        iconAnchor: [15,30]
      });
      const marker = L.marker([stop.lat, stop.lon], { icon: numberIcon })
        .addTo(map)
        .bindTooltip(`${i+1}. ${stop.name}`, { 
          permanent: true,
          direction: "top",
          offset: [0,-35],
          className: "stop-label"
        });
      markers.push(marker);
    });
    if (markers.length > 0) {
      const group = L.featureGroup(markers);
      map.fitBounds(group.getBounds(), { padding: [40,40] });
    }
  }

  function initSortable() {
    if (sortable) sortable.destroy();
    sortable = Sortable.create(tbody, {
      animation: 150,
      onEnd: function() {
        const newStops = [];
        tbody.querySelectorAll("tr").forEach(row => {
          const oldIndex = parseInt(row.dataset.index, 10);
          newStops.push(stops[oldIndex]);
        });
        stops = newStops;
        updateTable();
        updateMarkers();
        initSortable();
      }
    });
  }

  function downloadGPX() {
    const now = new Date();
    const filename = `Stops-${now.getFullYear()}-${(now.getMonth()+1).toString().padStart(2,'0')}-${now.getDate().toString().padStart(2,'0')}-${now.getHours().toString().padStart(2,'0')}-${now.getMinutes().toString().padStart(2,'0')}.gpx`;

    let gpx = `<?xml version="1.0" encoding="UTF-8"?>
<gpx version="1.1" creator="GPXRouteViewer" xmlns="http://www.topografix.com/GPX/1/1">`;

    stops.forEach((s, i) => {
      gpx += `
  <wpt lat="${s.lat}" lon="${s.lon}">
    <name>${i+1}. ${s.name}</name>
  </wpt>`;
    });

    gpx += `
</gpx>`;

    const blob = new Blob([gpx], { type: "application/gpx+xml" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  downloadBtn.addEventListener("click", downloadGPX);
</script>
</body>
</html>
